name: Build
on:
  push:
    branches:
    - master
    - "[0-9]+_[0-9]+_X"
    - actions_tests
  pull_request:

jobs:
  android:
    runs-on: ubuntu-18.04
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      USE_CCACHE: 1
    steps:
      - uses: actions/checkout@v2
      - name: Android build
        uses: ./.github/actions/build-android
        with:
          node-version: '12.x'
          java-version: '11'

  ios:
    runs-on: macos-11
    name: iOS
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      USE_CCACHE: 1
      DEVELOPER_DIR: /Applications/Xcode_13.0.app/Contents/Developer
    steps:
      - uses: actions/checkout@v2
      - name: iOS build
        uses: ./.github/actions/build-ios
        with:
          node-version: '12.x'

  js:
    runs-on: ubuntu-latest
    name: JavaScript
    steps:
    - uses: actions/checkout@v2

    - name: Use Node.js 12.x
      uses: actions/setup-node@v1
      with:
        node-version: '12.x'

    - name: Cache Node.js modules
      id: node-cache
      uses: actions/cache@v2
      with:
        path: node_modules
        key: ${{ runner.OS }}-node-modules-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.OS }}-node-modules-
          ${{ runner.OS }}-

    - name: Install dependencies
      if: steps.node-cache.outputs.cache-hit != 'true'
      run: npm ci

    - name: Lint
      run: npm run lint:js
  
  package:
    runs-on: macos-11
    name: Package
    env:
      SDK_BUILD_CACHE_DIR: ${{ github.workspace }}/.native-modules
      DEVELOPER_DIR: /Applications/Xcode_13.0.app/Contents/Developer
    needs: [android, ios, js]
    steps:
    - uses: actions/checkout@v2
    - name: Create version tag
      run: |
        PACKAGE_VERSION=$(sed -n 's/^ *"version": *"//p' package.json | tr -d '"' | tr -d ',' | tr -d '[[:space:]]')
        TIMESTAMP=`date +'%Y%m%d%H%M%S'`
        VTAG="${PACKAGE_VERSION}.v${TIMESTAMP}"
        echo "vtag=${VTAG}" >> $GITHUB_ENV
    - name: Package
      uses: ./.github/actions/package
      with:
        node-version: '12.x'
        java-version: '11'
        vtag: ${{ env.vtag }}
